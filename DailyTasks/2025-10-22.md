# Daily Plan — 2025-10-22

Context
- 2025-10-21 delivered minimal GraphQL (health, entries_today), mounted /graphql, aligned CORS, and added a frontend Dashboard health check. See docs/WORKSPACE_CHANGES_2025-10-21.md.
- Pending high-impact items: secure cookie-based auth, CSRF protections, essential GraphQL mutations, tests, and CI.

Objectives (end-of-day)
- Ship secure session cookies (access/refresh) and CSRF protection.
- Expose core Entry mutations (create/update/delete) over GraphQL wired to services.
- Wire frontend to auth via cookies and ensure Apollo sends CSRF on mutations.
- Add minimal backend tests and CI jobs to keep the main branch green.
- Update docs and env templates.

Plan of Action (high impact first)
1) Backend: CSRF Middleware (double-submit token)
   - Implement middleware to:
     - Issue a non-httpOnly CSRF cookie (e.g., `hhh_csrf`) for safe methods (GET/HEAD/OPTIONS).
     - Validate `X-CSRF-Token` header on mutating methods (POST/PUT/PATCH/DELETE) for both REST and `/graphql` routes.
     - Respect allowed origins and `credentials` (cookies) per CORS config.
   - Files:
     - backend/src/api/middleware/csrf.py (implement)
     - backend/main.py (add middleware in app setup, ensure order: CORS -> CSRF -> routers)
     - backend/src/core/config.py (expose CSRF env options)
     - backend/.env.example (add CSRF_SECRET, CSRF_HEADER_NAME, SECURE_COOKIES, COOKIE_DOMAIN)

2) Backend: Cookie-based Session (JWT access+refresh)
   - /auth endpoints:
     - /register and /login: set httpOnly cookies: `hhh_at` (short-lived), `hhh_rt` (longer), `sameSite=lax`, `secure=true` in prod.
     - /refresh: rotate refresh token, issue new access cookie.
     - /logout: clear cookies (both).
     - Keep response body minimal (e.g., return `user`; do not echo tokens).
   - Files:
     - backend/src/api/rest/v1/auth.py (set cookies, add /refresh, /logout)
     - backend/src/core/security.py (helpers for token creation/rotation, cookie helpers)
     - backend/src/core/config.py and backend/.env.example (JWT_* durations, cookie domain/flags)

3) Backend: GraphQL Entry Mutations
   - Mutations:
     - `createEntry(input: CreateEntryInput): Entry`
     - `updateEntry(id: ID!, input: UpdateEntryInput): Entry`
     - `deleteEntry(id: ID!): Boolean` (soft delete)
   - Services:
     - backend/src/services/entry.py: add create/update/soft-delete logic, validations (non-empty content, enum).
   - Schema:
     - backend/src/api/graphql/schema.py: add `Mutation` type and wire resolvers to services.
   - Ensure CSRF middleware covers `/graphql` and rejects missing header on mutation posts.

4) Frontend: Apollo CSRF + Auth Flows
   - Apollo link:
     - Add a link that injects `X-CSRF-Token` from `hhh_csrf` cookie for non-query operations.
     - Keep `credentials: 'include'` (already present).
   - Auth forms:
     - `LoginForm`, `RegisterForm` to call REST endpoints (rely on cookies; do not store tokens in localStorage).
     - Ensure loading/error states and redirect UX.
   - Files:
     - frontend/src/lib/apollo.ts (add setContext link for CSRF)
     - frontend/src/components/auth/*.tsx (calls using fetch/axios and `credentials: 'include'`)

5) Tests (minimal but meaningful)
   - Backend unit:
     - services.entry: create/update/delete (soft-delete verified).
     - core.security: token creation/verify, refresh rotation.
   - Backend integration:
     - /auth register/login (cookies set).
     - CSRF: POST to /graphql mutation without header -> 403; with header -> 200.
     - /graphql health and entries_today still pass.
   - Placeholders for frontend component tests (optional if time constrained).

6) CI Pipelines (GitHub Actions)
   - frontend-ci:
     - `npm ci`, `npm run lint`, `npm run build`.
   - backend-ci:
     - `pip install -r backend/requirements/prod.txt`, `pytest -q`.
     - Create ephemeral SQLite DB and `alembic upgrade head` sanity step (if needed).
   - Location:
     - .github/workflows/frontend-ci.yml
     - .github/workflows/backend-ci.yml

7) Docs & Env Templates
   - docs/API.md: document GraphQL entry mutations, REST auth cookie semantics.
   - docs/DEPLOYMENT.md: CORS/cookies/CSRF envs; dev vs prod distinctions.
   - backend/.env.example: add missing JWT/CSRF/cookie envs.
   - Create docs/WORKSPACE_CHANGES_2025-10-22.md at end of day summarizing diffs and verification outputs.

Checklist (today — chunked)
- [ ] Chunk 1 — Security foundations (CSRF)
  - [x] Implement CSRF middleware (double-submit): set non-httpOnly `hhh_csrf` on safe methods
  - [x] Validate `X-CSRF-Token` on POST/PUT/PATCH/DELETE (REST + `/graphql`)
  - [x] Wire middleware in `backend/main.py` after CORS
  - [ ] Config/env: `CSRF_SECRET`, `CSRF_HEADER_NAME`, `SECURE_COOKIES`, `COOKIE_DOMAIN`; update `.env.example`
- [x] Chunk 2 — Cookie session auth (JWT access/refresh)
  - [x] /register and /login set httpOnly `hhh_at` (short) and `hhh_rt` (refresh)
  - [x] Add `/refresh` (rotate) and `/logout` (clear)
  - [x] Helpers in `core/security.py`; response payload returns `user` only
- [x] Chunk 3 — GraphQL Entry mutations
  - [x] Services: create/update/soft-delete with validation
  - [x] Schema: Mutation with `createEntry`, `updateEntry`, `deleteEntry`
  - [x] Ensure CSRF applies to `/graphql` POST mutations
- [x] Chunk 4 — Frontend plumbing (Apollo + auth forms)
  - [x] Add Apollo link to inject `X-CSRF-Token` from `hhh_csrf` cookie for non-Query ops
  - [x] Update Login/Register to use REST with `credentials: 'include'` and proper UX states
- [x] Chunk 5 — Tests
  - [x] Unit: services.entry (CRUD/soft-delete), core.security (token/rotation)
  - [x] Integration: /auth cookies set; CSRF rejection without header; success with header; GraphQL health/entries_today
- [x] Chunk 6 — CI
  - [x] frontend-ci: npm ci, lint, build
  - [x] backend-ci: pip install, pytest -q, optional alembic upgrade head
- [x] Chunk 7 — Docs & tracking
  - [x] Update docs/API.md and docs/DEPLOYMENT.md
  - [x] Update backend/.env.example; add docs/WORKSPACE_CHANGES_2025-10-22.md

Acceptance Criteria
- Logging in/registering sets httpOnly cookies; /refresh rotates; /logout clears.
- CSRF middleware blocks missing/invalid token on mutating requests; allows with correct header.
- GraphQL health + entries_today remain OK; Entry mutations work end-to-end.
- Frontend injects CSRF on GraphQL mutations; auth flows work via cookies without storing tokens.
- Tests pass locally; CI runs green on a clean checkout.
- Docs and env templates reflect new behavior.

Verification Plan
- Manual:
  - Start backend `uvicorn backend.main:app --reload --port 8000` and frontend `npm run dev`.
  - Visit app, run Login/Register; inspect cookies (httpOnly JWTs; readable CSRF).
  - Run a GraphQL mutation via app and via curl:
    - Without `X-CSRF-Token` -> expect 403.
    - With `X-CSRF-Token` matching `hhh_csrf` -> expect success.
- Automated:
  - `pytest -q`
  - `npm run build` (frontend)
- CI:
  - Confirm both workflows finish green on PR.

Risks/Notes
- Cookie domain/secure flags differ across dev/prod; ensure sensible defaults for dev.
- Middleware order matters (CORS should run before CSRF so preflight/same-origin checks work).
- Keep changes scoped per .clinerules; if scope grows, split PRs but aim to land the above today.

Stretch (if time remains)
- Add DataLoader usage for N+1-sensitive fields.
- Frontend tests for Dashboard health and auth forms via Apollo/Mock Service Worker.

End-of-Day Deliverables
- Updated backend auth/CSRF + GraphQL mutations
- Updated frontend Apollo link + auth flows
- Tests + CI workflows
- Updated docs and env templates
